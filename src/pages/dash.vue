<template>
    <header class="header">
        <a href="testing">
            <svg class="right-arrow-next" alt="Right arrow next" width="61" height="17" viewBox="0 0 61 17"
                fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M21.188 15V1.8959H25.0832C25.9755 1.8959 26.7545 2.00244 27.4204 2.21551C28.0996 2.42859 28.6256 2.76818 28.9985 3.23428C29.3847 3.70038 29.5778 4.31963 29.5778 5.09202C29.5778 5.74456 29.4113 6.33718 29.0784 6.86987C28.7588 7.38924 28.286 7.7488 27.6601 7.94856V8.02846C28.4458 8.17495 29.085 8.50788 29.5778 9.02725C30.0838 9.54662 30.3369 10.2591 30.3369 11.1647C30.3369 12.017 30.1238 12.7294 29.6976 13.3021C29.2848 13.8747 28.7055 14.3008 27.9597 14.5805C27.214 14.8602 26.3484 15 25.3629 15H21.188ZM22.846 7.46914H24.7836C25.9022 7.46914 26.7079 7.27604 27.2007 6.88984C27.6934 6.50364 27.9398 5.97761 27.9398 5.31176C27.9398 4.55268 27.6801 4.01333 27.1607 3.69372C26.6547 3.37411 25.8889 3.2143 24.8635 3.2143H22.846V7.46914ZM22.846 13.6816H25.1232C26.2551 13.6816 27.1341 13.4752 27.76 13.0624C28.3859 12.6362 28.6988 11.9837 28.6988 11.1047C28.6988 10.2924 28.3859 9.69976 27.76 9.32688C27.1474 8.94069 26.2685 8.74759 25.1232 8.74759H22.846V13.6816ZM35.009 15.2397C34.1967 15.2397 33.5175 15 32.9715 14.5206C32.4388 14.0278 32.1724 13.3487 32.1724 12.4831C32.1724 11.4177 32.6452 10.6053 33.5907 10.046C34.5496 9.47337 36.0611 9.07386 38.1252 8.84747C38.1252 8.43463 38.0653 8.04178 37.9454 7.6689C37.8389 7.29602 37.6391 6.99638 37.3462 6.76999C37.0665 6.53028 36.6603 6.41042 36.1276 6.41042C35.5683 6.41042 35.0423 6.51696 34.5496 6.73003C34.0568 6.94311 33.6174 7.18282 33.2312 7.44916L32.5919 6.31054C33.0447 6.01757 33.5974 5.73791 34.2499 5.47156C34.9158 5.1919 35.6349 5.05207 36.4073 5.05207C37.5925 5.05207 38.4515 5.41829 38.9842 6.15074C39.5169 6.86987 39.7832 7.83536 39.7832 9.04722V15H38.4249L38.285 13.8414H38.2251C37.7723 14.2143 37.2729 14.5406 36.7269 14.8202C36.1942 15.0999 35.6216 15.2397 35.009 15.2397ZM35.4884 13.9213C35.9545 13.9213 36.394 13.8081 36.8068 13.5817C37.2197 13.3553 37.6591 13.0357 38.1252 12.6229V9.92616C36.5138 10.1259 35.3819 10.4256 34.7293 10.8251C34.0901 11.2246 33.7705 11.7373 33.7705 12.3632C33.7705 12.9092 33.937 13.3087 34.2699 13.5617C34.6028 13.8015 35.009 13.9213 35.4884 13.9213ZM46.673 15.2397C45.8207 15.2397 45.0483 15.04 44.3558 14.6404C43.6633 14.2409 43.1173 13.6616 42.7178 12.9025C42.3183 12.1435 42.1185 11.2312 42.1185 10.1659C42.1185 9.07386 42.3316 8.14831 42.7577 7.38924C43.1972 6.63016 43.7698 6.05086 44.4756 5.65134C45.1948 5.25183 45.9672 5.05207 46.7928 5.05207C47.4321 5.05207 47.9781 5.16527 48.4308 5.39166C48.8969 5.61805 49.2965 5.88439 49.6294 6.19069L48.7904 7.26938C48.5107 7.01635 48.2111 6.80994 47.8915 6.65013C47.5852 6.49033 47.239 6.41042 46.8528 6.41042C46.2668 6.41042 45.7408 6.57023 45.2747 6.88984C44.8219 7.19614 44.4623 7.6356 44.196 8.20824C43.943 8.76756 43.8164 9.4201 43.8164 10.1659C43.8164 11.2712 44.0894 12.1701 44.6354 12.8626C45.1948 13.5418 45.9206 13.8814 46.8128 13.8814C47.2656 13.8814 47.6851 13.7881 48.0713 13.6017C48.4575 13.4019 48.7971 13.1689 49.09 12.9025L49.8092 14.0012C49.3697 14.3874 48.8836 14.6937 48.3509 14.9201C47.8183 15.1332 47.2589 15.2397 46.673 15.2397ZM51.9477 15V0.777259H53.5657V10.4056H53.6256L57.7606 5.29178H59.5784L56.3224 9.18705L60.0179 15H58.2201L55.3835 10.3257L53.5657 12.4431V15H51.9477Z"
                    fill="#EDEDED" />
                <path
                    d="M5.44684 8.84758L10.8577 14.2585C11.0501 14.4508 11.3609 14.4508 11.5533 14.2585C11.7456 14.0661 11.7456 13.7553 11.5533 13.5629L6.49016 8.49982L11.5533 3.43672C11.7456 3.24439 11.7456 2.93351 11.5533 2.74118C11.4573 2.64526 11.3314 2.59705 11.2055 2.59705C11.0796 2.59705 10.9536 2.64526 10.8577 2.74118L5.44682 8.15207C5.25452 8.34437 5.25452 8.65526 5.44684 8.84758Z"
                    stroke="#EDEDED" stroke-width="1.41873" />
            </svg>
        </a>
    </header>
    <div class="container">
        <notallowGuest></notallowGuest>
        <!-- Calendar Section -->
        <div class="calendar-section">
            <div class="main-calendar">
                <div class="calendar-header">
                    <h2 class="poppins-bold">{{ thisMonth }}, {{ thisYear }}</h2>
                    <h3>{{ formattedToday }}</h3>
                </div>
                <div class="calendar-grid">
                    <div class="block" v-for="day in daysActivity" :key="day.date" >
                        <p class="date-block" :class="{ 'highlight-today': isToday(day.date) }">{{ getDay(day.date) }}<br></p>
                        <div class="time-block" :class="day.activity_level">
                            {{ formatTime(day.hours_studied / 60)  }}h
                        </div>
                    </div>
                </div>
            </div>
            <div class="calendar-descripton">
                The more time you spend working, the darker the rectangle for each day becomes! 
            </div>
            <svg class="calendar-block-description" width="118" height="19" viewBox="0 0 118 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect width="18.4" height="18.4" rx="3.03423" fill="#2A2A2A"/>
                <rect x="24.7998" y="-3.05176e-05" width="18.4" height="18.4" rx="3.03423" fill="#FFD800" fill-opacity="0.25"/>
                <rect x="49.6001" y="-3.05176e-05" width="18.4" height="18.4" rx="3.03423" fill="#FFD800" fill-opacity="0.5"/>
                <rect x="74.3999" y="-3.05176e-05" width="18.4" height="18.4" rx="3.03423" fill="#FFD800" fill-opacity="0.75"/>
                <rect x="99.2002" y="-3.05176e-05" width="18.4" height="18.4" rx="3.03423" fill="#FFD800"/>
            </svg>
        </div>

        <!-- Summary Section -->
        <div class="summary-section">
            <h3 class="summary-title poppins-bold">Your working time in this</h3>
            <div class="time-summary">
              <div class="time-box">
                <span class="time-label">Day</span>
                <span class="time-value">{{ formatTime(timeAnalysis.totalTimeOfToday / 60)}} h</span>
              </div>
              <div class="time-box">
                <span class="time-label">Week</span>
                <span class="time-value">{{ formatTime(timeAnalysis.totalTimeOfWeek / 60)}} h</span>
              </div>
              <div class="time-box">
                <span class="time-label">Month</span>
                <span class="time-value">{{ formatTime(timeAnalysis.totalTimeOfMonth / 60)}} h</span>
              </div>
            </div>
            <div class="average-time">  
                <svg class="avearage-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M23.8001 23.1999H0.600098V-6.10352e-05H2.0501V21.7499H23.8001V23.1999Z" fill="#EDEDED" stroke="#EDEDED" stroke-width="0.0453125"/>
                    <path d="M11.9601 16.9423L8.40545 11.6984L5.67873 16.93L4.39258 16.2601L8.24233 8.87379L11.7956 14.1155L15.1429 7.68479L18.1582 12.3494L21.2401 4.02209L22.5995 4.52452L18.512 15.5692L15.2785 10.5652L11.9601 16.9423Z" fill="#E04F5F" stroke="#EDEDED" stroke-width="0.0453125"/>
                    <path d="M22.4036 7.36365L21.7091 4.87763L19.3289 5.889L18.7627 4.55355L22.6625 2.89838L23.8 6.97433L22.4036 7.36365Z" fill="#E04F5F" stroke="#EDEDED" stroke-width="0.0453125"/>
                </svg>    
                <span class="average-time-label">
                    Average time a day:
                </span>
                <span class="average-time-value">{{ formatTime(divideDaysActivityLength(timeAnalysis.totalTimeOfMonth))}} h</span>
            </div>
            <div class="summary-descripton">
                Use Timer feature and complete a session of at least 25 minutes to record your working time! 
            </div>
        </div>

        <!-- Leaderboard Section -->
        <div class="leaderboard-section">
            <h3 class="poppins-bold">Leaderboard</h3>
            <div class="leaderboard-header">
                <span class="header-rank">Rank</span>
                <span class="header-total">Total</span>
            </div>
            <div v-for="(user, index) in topUsers" :key="user.rank" class="leaderboard-item">
                <span class="rank">{{ index + 1 }}</span>
                <span class="user-info">{{ user.name }}</span>
                <span class="total-time">{{ (user.totalWorkingTime / 60).toFixed(2)}} h</span>
            </div>
        
            <div class="your-rank">
                <div class="rank-info">
                    <div>Your Rank</div>
                    <div class="rank-number">#{{ currentRank + 1 }}</div>
                </div>
                <div class="rank-info" v-if="totalTime !== Nan">
                    <div>Your Total time</div>
                    <div class="total-time-number">{{ formatTime(totalTime / 60) }} h</div>
                </div>
                <div class="rank-info" v-if="totalTime === Nan">
                    <div>Your Total time</div>
                    <div class="total-time-number"> 0  h</div>
                </div>
            </div>
        </div>
    </div>
</template>

<script setup>
const { data: token } = await useFetch('/api/token')
if (token.value) {
  if (token.value.role == 'Admin' || token.value.role == 'admin') {
    await navigateTo('/admin-user')
  }
}

import NotallowGuest from '~/components/notallowGuest.vue';
import './assets/base.css';

const daysActivity = ref()

function getDay(date) {
    return new Date(date).getDate();
}

function formatTime(value) {
    if (value !== 0) {
        return value.toFixed(2);
    }
    return value;
}

function divideDaysActivityLength(time) {
    const length = daysActivity.value.length - 1;
    if (time === 0) {
        return 0;
    }
    return time / (length*60);
}

const today = new Date();

const formattedToday = computed(() => {
  const options = { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' };
  return today.toLocaleDateString('en-US', options);
});

const isToday = (date) => {
    const givenDate = new Date(date);
    return givenDate.toDateString() === today.toDateString();
};

const thisMonthIndex = new Date().getMonth();
const thisYear = ref()
thisYear.value = new Date().getFullYear();

const monthNames = [
    "January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"
];

const thisMonth = ref()
thisMonth.value = monthNames[thisMonthIndex];


daysActivity.value = await $fetch('/api/dashboard', {
    method: 'POST',
    body: {
        action: 'getDailyActivities',
    }
})

console.log(daysActivity.value)
// console.log('Received data:', daysActivity.value[0])
// Hàm tạo danh sách các ngày từ ngày bắt đầu đến ngày kết thúc


const topUsers = ref("")
const topRankList = ref("")
topRankList.value = await $fetch('/api/dashboard', {
    method: 'POST',
    body: {
        action: 'getRanks',
    }
})
topUsers.value = topRankList.value



const currentRankInfo = ref("")
const totalTime = ref("2")
const currentRank = ref("1")

// currentRankInfo.value = await $fetch('/api/dashboard', {
currentRank.value = await $fetch('/api/dashboard', {
    method: 'POST',
    body: {
        action: 'getCurrentStanding',
    }
})

totalTime.value = await $fetch('/api/dashboard', {
    method: 'POST',
    body: {
        action: 'getTotalTime',
    }
})

console.log('thing:', currentRankInfo.value)

// currentRank.value = currentRankInfo.value.top
// totalTime.value = currentRankInfo.value.totalTimeSoFar


const timeAnalysis = ref("")
timeAnalysis.value = await $fetch('/api/dashboard', {
    method: 'POST',
    body: {
        action: 'getByTime',
    }
})




// console.log("----------------------------")
// console.log('Received data:', timeAnalysis.value)
// console.log('Received data:', daysActivity.value)
// console.log('Received data:', currentRankInfo.value)
// console.log('Received data:', topRankList.value)
// console.log('Received data:', daysActivity.value)
// console.log("----------------------------")



</script>

<style>
@import url('https://fonts.googleapis.com/css1?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');

.body {
    margin: 0px;
    padding: 0px;
    background-color: #222222;
}

.container {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    padding-top: 35px;
    padding-right: 10px;
    background-color: #222222;
    color: #ededed;
    margin-left: 60px;
    margin-right: 60px;
}

.header {
    cursor: pointer;
    align-self: flex-start;
    display: flex;
    color: #ededed;
    background-color: #222222;
    font: 400 20px 'Source Sans 3', sans-serif;
    padding-left: 15px;
    padding-top:15px;
}

.summary-section,
.leaderboard-section {
    width: 30%;
    border-radius: 12.137px;
    border: 0.607px solid #7A7A7A;
}

.calendar-section {
    width: 408.95px;
    height: fit-content;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.main-calendar {
    padding-right: 20px;
    padding-left: 20px;
    padding-bottom: 20px;
    border-radius: 12.137px;
    border: 0.607px solid #7A7A7A;
}

.calendar-block-description {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    margin-top: 10px;
}

.calendar-header h2 {
    text-align: center;
    margin-top: 17.6px;
    font-size: 19.419px;
    
    font-family: "Poppins";
    font-weight: 700;
    font-style: normal;
}

.calendar-header h3 {
    text-align: right;
    margin-top: 17.6px;
    margin-bottom: 0px;
    margin-right: 5px;
    font-size: 16px;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4.85px;
    margin-top: 20px;
}

.calendar-descripton {
    text-align: center;
    color: #EDEDED;
    text-align: center;
    font-family: Poppins;
    font-size: 16px;
    font-style: normal;
    font-weight: 400;
    line-height: normal;
    margin-top: 13.4px;
}

.calendar-grid p {
    text-align: center;
    margin: 0px;
}

.date-block {
    color: #EDEDED;
    text-align: center;
    font-family: "Source Sans 3";
    font-size: 14.56px;
    font-style: normal;
    font-weight: 700;
    line-height: normal;
}

.block {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    border-radius: 5px;
    padding-bottom: 7px;
}

.time-block {
    text-align: center;
    display: flex;
    border-radius: 3.034px;
    font-family: "Source Sans 3";
    justify-content: center;
    align-items: center;
    font-size: 12px;
    width: 48.548px;
    height: 18.205px;
}

.no-study {
    background-color: rgba(42, 42, 42, 1);
}

.low-activity {
    background-color: rgba(255, 216, 0, 0.25);
}

.medium-activity {
    background-color: rgba(255, 216, 0, 0.5);
}

.medium-high-activity {
    background-color: rgba(255, 216, 0, 0.75);
}

.high-activity {
    background-color: rgba(255, 216, 0, 1);
}

.highlight-today {
    color: #ffd800;
}

.summary-section div {
    display: flex;
    margin-bottom: 10px;
    font-size: 16px;
}

.summary-section h3 {
    margin-top: 17.6px;
}

.summary-section {
    height: 207.2px;
    border-radius: 10px;
    color: #fff;
    margin: 0;
}

.summary-title {
    font-size: 18px;
    margin-bottom: 17px;
    margin-left: 30px;
}

.time-summary {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 6.8px;
    margin-bottom: 20px;
}

.time-box {
    border-radius: 9.106px;
    width: 122.4px;
    height: 76px;
    background: #2A2A2A;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.time-label {
    display: block;
    font-weight: bold;
    font-size: 14px;
    color: #ffd800;
    margin-bottom: 5px;
}

.time-value {
    color: #EDEDED;
    text-align: center;
    font-family: "Source Sans 3";
    font-size: 25.6px;
    font-style: normal;
    font-weight: 900;
    line-height: normal;
}

.average-time {
    display: flex;
    justify-content: left;
    align-items: center;
    text-align: left;
    font-size: 18px;
}

.avearage-icon {
    margin-top: 5px;
    margin-left: 29.6px;
    margin-right: 5px;
}

.average-time-label {
    font-weight: bold;
    color: #ffd800;
    margin-right: 5px;
}

.average-time-value {
    font-size: 24px;
    font-weight: bold;
    color: #fff;
}

.summary-descripton {
    text-align: center;
    color: #EDEDED;
    text-align: center;
    font-family: Poppins;
    font-size: 16px;
    font-style: normal;
    font-weight: 400;
    line-height: normal;
    margin-top: 25px;
}

.leaderboard-section {
    width: 392.8px;
    height: fit-content;
    padding: 20px;
    border-radius: 10px;
    color: white;
    font-family: 'Poppins', sans-serif;
    margin: 0;
}

.leaderboard-section h3 {
    margin: 0  ;
}

.leaderboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 10px;
    margin-top: 10.85px;
}

.header-rank, .header-total {
    text-align: center;
    font-family: "Source Sans 3";
    color: #EDEDED;
    text-align: center;
    font-size: 15.652px;
    font-style: normal;
    font-weight: 700;
    line-height: normal;
}

.leaderboard-title {
    font-size: 20px;
    margin-bottom: 15px;
    margin-top: 17.6px;
    text-align: left;
}

.leaderboard-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #383838;
    font-size: 16px;
}

.rank {
    width: 30px;
    color: #EDEDED;
    text-align: center;
    font-family: Poppins;
    font-size: 20.401px;
    font-style: normal;
    font-weight: 700;
    line-height: normal;
}

.user-info {
    flex-grow: 1;
    margin-left: 10px;
    display: flex;
    align-items: center;
    font-family: "Source Sans 3";
}

.total-time {
    width: 60px;
    text-align: right;
    font-weight: bold;
}

.leaderboard-item:nth-child(1) .user-info,
.leaderboard-item:nth-child(1) .total-time {
    color: #FFD800;
}

.your-rank {
    margin-top: auto; 
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    text-align: center;
    font-size: 14px;
    color: #ededed;
    margin-top: 33px;
}

.rank-info {
    color: #FFD800;
    text-align: center;
    font-family: Poppins;
    font-size: 12.751px;
    font-style: normal;
    font-weight: 700;
    line-height: normal;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
}

.rank-number {
    background-color: #2A2A2A;
    color: #EDEDED;
    text-align: center;
    font-family: "Source Sans 3";
    font-size: 22.952px;
    font-style: normal;
    font-weight: 900;
    border-radius: 8px;
    font-weight: bold;
    margin: 5px 0;
    width: 127.509px;
    height: 35.065px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.total-time-number {
    background-color: #2A2A2A;
    color: #EDEDED;
    text-align: center;
    font-family: "Source Sans 3";
    font-size: 22.952px;
    font-style: normal;
    font-weight: 900;
    line-height: normal;
    border-radius: 8px;
    font-weight: bold;
    margin: 5px 0;
    width: 127.509px;
    height: 35.065px;
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>